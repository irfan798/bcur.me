<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BC-UR Playground</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/tabs.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîÑ BC-UR Playground</h1>
            <p>Explore Uniform Resources, multi-part encoding, animated QR codes, and CBOR registry types</p>
        </div>

        <!-- Tab Navigation -->
        <nav class="tab-nav">
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="converter">
                    <span class="tab-icon">üîÑ</span>
                    <span class="tab-label">Converter</span>
                </button>
                <button class="tab-button" data-tab="multi-ur">
                    <span class="tab-icon">üìö</span>
                    <span class="tab-label">Multi-UR Generator</span>
                </button>
                <button class="tab-button" data-tab="scanner">
                    <span class="tab-icon">üì∑</span>
                    <span class="tab-label">QR Scanner</span>
                </button>
                <button class="tab-button" data-tab="registry">
                    <span class="tab-icon">üìñ</span>
                    <span class="tab-label">Registry Browser</span>
                </button>
            </div>
        </nav>

        <!-- Tab 1: Converter (existing converter content) -->
        <div class="tab-content active" id="converter-tab">
            <div class="examples">
                <div class="examples-label">Quick Examples:</div>
                <div class="example-buttons">
                    <button class="example-btn" data-example="hex">Hex Example</button>
                    <button class="example-btn" data-example="ur">UR Example</button>
                    <button class="example-btn" data-example="bytewords">Bytewords Example</button>
                    <button class="example-btn" data-example="multiur">Multi-part UR</button>
                    <button class="example-btn" data-example="detailed-account">Detailed Account</button>
                    <button class="example-btn" data-example="portfolio">Portfolio (complex-ur)</button>
                </div>
            </div>

            <div class="converter-panel">
                <div class="input-section">
                    <div class="section-label">Input</div>
                    <div class="format-row">
                        <select id="inputFormat" class="format-select format-select-inline">
                            <option value="auto">üîç Auto-detect format</option>
                            <option value="multiur">üìö Multi-part UR</option>
                            <option value="ur">üìÑ Single UR</option>
                            <option value="bytewords">üìù Bytewords</option>
                            <option value="hex">üî¢ Hex (CBOR)</option>
                        </select>
                        <select id="inputBytewordsStyle" class="bytewords-style-select" style="display:none;">
                            <option value="minimal">Minimal</option>
                            <option value="standard">Standard</option>
                            <option value="uri">URI</option>
                        </select>
                    </div>
                    <textarea
                        id="inputText"
                        class="text-area"
                        placeholder="Paste or type your input here..."
                        spellcheck="false"
                    ></textarea>
                </div>

                <div class="output-section">
                    <div class="section-label">Output</div>
                    <div class="format-row">
                        <select id="outputFormat" class="format-select format-select-inline">
                            <option value="ur">üìÑ Single UR</option>
                            <option value="bytewords">üìù Bytewords</option>
                            <option value="hex">üî¢ Hex (CBOR)</option>
                            <option value="decoded-json">üìä Decoded CBOR (JSON)</option>
                            <option value="decoded-diagnostic">üìã Decoded CBOR (Diagnostic)</option>
                            <option value="decoded-commented">üí¨ Decoded CBOR (Commented)</option>
                            <option value="decoded-js">üîß Decoded CBOR (JavaScript)</option>
                        </select>
                        <select id="outputBytewordsStyle" class="bytewords-style-select" style="display:none;">
                            <option value="minimal">Minimal</option>
                            <option value="standard">Standard</option>
                            <option value="uri">URI</option>
                        </select>
                        <button id="copyBtn" class="example-btn" style="margin-left:8px; padding:10px 14px; height:42px;">üìã Copy</button>
                        <button id="sendToMultiUR" class="example-btn" style="margin-left:8px; padding:10px 14px; height:42px;">üìö Send to Multi-UR</button>
                    </div>
                    <!-- UR Type override / helper (appears only when needed) -->
                    <div id="urTypeContainer" style="display:none; margin-bottom:12px; position:relative;">
                        <input id="urTypeInput" type="text" placeholder="unknown-tag" style="width:100%; padding:8px 32px 8px 10px; border:2px solid #e1e4e8; border-radius:6px; font-size:13px;" />
                        <span id="urTypeIndicator" style="display:none; position:absolute; top:8px; right:10px; font-size:15px; user-select:none;">‚úì</span>
                        <div style="display:flex; justify-content:space-between; margin-top:4px;">
                            <small id="urTypeHint" style="color:#586069; font-size:11px;">Provide UR type (auto when CBOR tag known)</small>
                            <small id="urTypeAutoBadge" style="display:none; background:#e1f5e6; color:#0a7a25; padding:2px 6px; border-radius:12px; font-size:11px;">Auto-detected</small>
                        </div>
                    </div>
                    <textarea
                        id="outputText"
                        class="text-area"
                        readonly
                        placeholder="Converted output will appear here..."
                        spellcheck="false"
                    ></textarea>

                    <!-- Registry Item UI (appears when decoded-js shows a registry item) -->
                    <div id="registry-item-ui" style="display: none; margin-top: 16px;">
                        <!-- Interactive Console Hints Panel -->
                        <div id="console-hints-panel" class="registry-panel">
                            <div class="panel-header">üí° Console Playground</div>
                            <div class="console-hints-content">
                                <div class="hint-item">
                                    <code class="hint-code">window.$lastRegistryItem</code>
                                    <button class="copy-hint-btn" data-hint="window.$lastRegistryItem">üìã</button>
                                </div>
                                <div class="hint-item">
                                    <code class="hint-code">window.$lastRegistryItem.toUR()</code>
                                    <button class="copy-hint-btn" data-hint="window.$lastRegistryItem.toUR()">üìã</button>
                                </div>
                                <div class="hint-item">
                                    <code class="hint-code">window.$lastRegistryItem.getRegistryType()</code>
                                    <button class="copy-hint-btn" data-hint="window.$lastRegistryItem.getRegistryType()">üìã</button>
                                </div>
                            </div>
                        </div>

                        <!-- Expandable Tree View -->
                        <div id="tree-view-panel" class="registry-panel">
                            <div class="panel-header">üîç Property Inspector</div>
                            <div id="tree-view-content" class="tree-view-content">
                                <!-- Tree view will be rendered here -->
                            </div>
                        </div>

                        <!-- Methods Display Panel -->
                        <div id="methods-panel" class="registry-panel">
                            <div class="panel-header">‚ö° Available Methods</div>
                            <div id="methods-content" class="methods-content">
                                <!-- Methods list will be rendered here -->
                            </div>
                        </div>

                        <!-- Copy Options -->
                        <div id="copy-options-panel" class="registry-panel">
                            <div class="panel-header">üìã Export Options</div>
                            <div class="copy-options-content">
                                <button class="copy-option-btn" data-format="json">Copy as JSON</button>
                                <button class="copy-option-btn" data-format="hex">Copy as Hex</button>
                                <button class="copy-option-btn" data-format="ur">Copy as UR</button>
                                <button class="copy-option-btn" data-format="code">Copy Registry Item Code</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pipeline" id="pipeline">
                <div class="pipeline-header">Conversion Pipeline Status</div>
                <div class="pipeline-flow">
                    <span class="pipeline-step inactive" data-step="multiur">Multi-UR</span>
                    <span class="pipeline-arrow">‚Üí</span>
                    <span class="pipeline-step inactive" data-step="ur">UR</span>
                    <span class="pipeline-arrow">‚Üí</span>
                    <span class="pipeline-step inactive" data-step="bytewords">Bytewords</span>
                    <span class="pipeline-arrow">‚Üí</span>
                    <span class="pipeline-step inactive" data-step="hex">Hex</span>
                    <span class="pipeline-arrow">‚Üí</span>
                    <span class="pipeline-step inactive" data-step="decoded">Decoded</span>
                </div>
            </div>

            <div class="status success" id="status">
                <span class="status-icon">‚ÑπÔ∏è</span>
                <span>Ready for input</span>
            </div>
        </div>

        <!-- Tab 2: Multi-UR Generator -->
        <div class="tab-content hidden" id="multi-ur-tab">
            <div class="section-label">üìö Multi-Part UR Generator & Animated QR</div>

            <!-- Status Message -->
            <div id="multi-ur-status" class="status">
                <span class="status-icon">‚ÑπÔ∏è</span>
                <span>Enter a UR or hex string to generate multi-part URs</span>
            </div>

            <!-- Input Section with Parts List Side-by-Side -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
                <!-- Left: Input -->
                <div class="input-section" style="display: flex; flex-direction: column;">
                    <div class="section-label">Input UR or Hex</div>
                    <textarea
                        id="multi-ur-input"
                        class="text-area"
                        style="flex: 1; min-height: 200px; resize: vertical;"
                        placeholder="Paste UR (ur:...) or hex string here, or receive from Converter tab..."
                        spellcheck="false"
                    ></textarea>
                </div>

                <!-- Right: All Parts List (finite mode only) -->
                <div class="output-section" style="display: flex; flex-direction: column;">
                    <div class="section-label">All Parts (Finite Mode)</div>
                    <div id="parts-list-output" style="display: none; flex: 1; min-height: 200px; max-height: 400px; overflow-y: auto; border: 1px solid #e1e4e8; border-radius: 6px; padding: 12px; background: white;">
                        <!-- Parts list will be populated here -->
                    </div>
                    <div id="parts-list-placeholder" style="flex: 1; min-height: 200px; display: flex; align-items: center; justify-content: center; border: 2px dashed #e1e4e8; border-radius: 6px; color: #586069; font-size: 0.9em;">
                        Generate parts to see list
                    </div>
                </div>
            </div>

            <!-- Encoder Parameters Section -->
            <div class="encoder-params-section" style="margin-top: 24px;">
                <div class="section-label">Encoder Parameters</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 12px;">
                    <div>
                        <label for="max-fragment-length" style="display: block; margin-bottom: 4px; font-size: 0.9em; color: #586069;">Max Fragment Length:</label>
                        <input type="number" id="max-fragment-length" value="90" min="10" max="2000" style="width: 100%; padding: 8px; border: 2px solid #e1e4e8; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div>
                        <label for="min-fragment-length" style="display: block; margin-bottom: 4px; font-size: 0.9em; color: #586069;">Min Fragment Length:</label>
                        <input type="number" id="min-fragment-length" value="10" min="1" max="1000" style="width: 100%; padding: 8px; border: 2px solid #e1e4e8; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div>
                        <label for="first-seq-num" style="display: block; margin-bottom: 4px; font-size: 0.9em; color: #586069;">First Sequence Number:</label>
                        <input type="number" id="first-seq-num" value="0" min="0" style="width: 100%; padding: 8px; border: 2px solid #e1e4e8; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div>
                        <label for="repeat-after-ratio" style="display: block; margin-bottom: 4px; font-size: 0.9em; color: #586069;">Repeat After Ratio (0 = infinite):</label>
                        <input type="number" id="repeat-after-ratio" value="2" min="0" max="10" step="0.1" style="width: 100%; padding: 8px; border: 2px solid #e1e4e8; border-radius: 6px; font-size: 14px;">
                    </div>
                </div>

                <!-- Parameter Validation Error -->
                <div id="param-validation-error" class="status error" style="display: none; margin-top: 12px;"></div>

                <!-- Mode Badge -->
                <div style="margin-top: 12px; display: flex; align-items: center; justify-content: space-between;">
                    <span id="mode-badge" class="mode-badge finite"># Finite Mode</span>
                    <button id="generate-multi-ur" class="example-btn" style="padding: 12px 24px; font-size: 1em; min-height: 48px;">üöÄ Generate Multi-UR</button>
                </div>
            </div>

            <!-- QR Display Section (hidden until generated) -->
            <div id="qr-display-section" style="display: none; margin-top: 24px;">
                <div class="section-label">Animated QR Code</div>
                <div style="text-align: center; margin-top: 16px;">
                    <canvas id="multi-ur-qr-canvas" style="max-width: 100%; border: 2px solid #e1e4e8; border-radius: 8px;"></canvas>
                </div>

                <!-- Frame Indicator -->
                <div id="frame-indicator" style="text-align: center; margin-top: 12px; font-size: 0.95em; color: #586069;">
                    Part 1 of 10
                </div>

                <!-- Encoder Blocks Grid -->
                <div style="margin-top: 24px;">
                    <div class="section-label">Fragment Composition</div>
                    <div id="encoder-blocks-grid" class="encoder-blocks-visualization"></div>
                </div>

                <!-- Grid Legend (same as scanner) -->
                <div class="grid-legend" style="margin-top: 12px;">
                    <div class="legend-item">
                        <span class="legend-color decoded"></span>
                        <span>Included in fragment</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color pending"></span>
                        <span>Not included</span>
                    </div>
                </div>
            </div>

            <!-- Animation Controls (hidden until generated) -->
            <div id="animation-controls" style="display: none; margin-top: 24px;">
                <div class="section-label">Animation Controls</div>
                <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-top: 12px;">
                    <button id="play-animation" class="example-btn" style="min-height: 48px;">‚ñ∂Ô∏è Play</button>
                    <button id="pause-animation" class="example-btn" style="display: none; min-height: 48px;">‚è∏Ô∏è Pause</button>
                    <button id="restart-animation" class="example-btn" style="min-height: 48px;">üîÑ Restart</button>
                    <button id="next-frame" class="example-btn" style="min-height: 48px;">‚è≠Ô∏è Next Frame</button>

                    <div style="flex: 1; min-width: 200px; display: flex; align-items: center; gap: 8px;">
                        <label for="fps-slider" style="font-size: 0.9em; color: #586069; white-space: nowrap;">FPS:</label>
                        <input type="range" id="fps-slider" min="1" max="30" value="5" style="flex: 1; min-width: 100px;">
                        <span id="fps-value" style="font-size: 0.9em; color: #586069; min-width: 30px;">5</span>
                    </div>
                </div>

                <!-- Progress Bar (finite mode only) -->
                <div class="progress-bar-container" style="margin-top: 12px;">
                    <div id="animation-progress-bar" class="progress-bar"></div>
                </div>
            </div>

            <!-- Output Section (hidden until generated) -->
            <div id="multi-ur-output" style="display: none; margin-top: 24px;">
                <div class="section-label">Current Part Output</div>
                <textarea
                    id="current-part-output"
                    class="text-area"
                    readonly
                    rows="2"
                    placeholder="Current UR part will appear here..."
                    spellcheck="false"
                ></textarea>

                <!-- Copy & Export Buttons -->
                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px;">
                    <button id="copy-current-part" class="example-btn" style="min-height: 48px;">üìã Copy Current Part</button>
                    <button id="copy-all-parts" class="example-btn" style="min-height: 48px;">üìã Copy All Parts</button>
                    <button id="copy-qr-png" class="example-btn" style="min-height: 48px;">üñºÔ∏è Copy QR as PNG</button>
                    <button id="export-gif" class="example-btn" style="min-height: 48px;" title="Export as animated GIF (finite mode only)">üíæ Export GIF</button>
                </div>
            </div>

            <!-- Usage Instructions -->
            <div class="usage-instructions" style="margin-top: 32px;">
                <div class="section-label">üìù How to Use</div>
                <ol>
                    <li>Enter a UR (ur:...) or hex string, or receive from Converter tab</li>
                    <li>Configure encoder parameters:
                        <ul>
                            <li><strong>Max/Min Fragment Length:</strong> Controls QR code size (smaller = more parts)</li>
                            <li><strong>Repeat After Ratio:</strong> 0 = infinite streaming, &gt;0 = finite with redundancy</li>
                        </ul>
                    </li>
                    <li>Click <strong>Generate Multi-UR</strong> to encode</li>
                    <li>Watch animated QR code and fragment composition grid</li>
                    <li>Use controls to adjust animation speed (FPS slider)</li>
                    <li>Copy individual parts, all parts, or export as GIF</li>
                </ol>
                <p style="color: #586069; font-size: 0.9em; margin-top: 8px;">
                    üí° <strong>Tip:</strong> Use infinite mode (ratio=0) for continuous testing, finite mode for complete QR sequences
                </p>
            </div>
        </div>

        <!-- Tab 3: QR Scanner -->
        <div class="tab-content hidden" id="scanner-tab">
            <div class="section-label">üì∑ QR Code Scanner & Fountain Decoder</div>
            
            <!-- Camera Status -->
            <div id="camera-status" class="status">Camera: Starting...</div>
            
            <!-- Camera Controls -->
            <div class="scanner-controls">
                <button id="stop-camera" class="example-btn" style="display:none;">‚èπÔ∏è Stop Camera</button>
                <button id="reset-scanner" class="example-btn" style="display:none;">üîÑ Reset</button>
                <button id="toggle-torch" class="example-btn" style="display:none;">üî¶ Torch: OFF</button>
            </div>
            
            <!-- Type Mismatch Warning -->
            <div id="type-mismatch-warning" class="status error" style="display:none; margin-top:12px;"></div>
            
            <!-- Video Preview -->
            <div class="scanner-preview">
                <video id="scanner-video" playsinline></video>
            </div>
            
            <!-- Progress Display -->
            <div id="scan-progress" class="section-label" style="display:none; margin-top:16px;">
                Waiting for first QR code...
            </div>
            
            <!-- Progress Bar -->
            <div class="progress-bar-container" style="margin-top:12px;">
                <div id="progress-bar" class="progress-bar"></div>
            </div>
            
            <!-- Blocks Grid Visualization -->
            <div class="section-label" style="margin-top:24px;">Block Status Grid</div>
            <div id="blocks-grid" class="blocks-grid"></div>
            
            <!-- Grid Legend -->
            <div class="grid-legend">
                <div class="legend-item">
                    <span class="legend-color decoded"></span>
                    <span>Decoded (resolved)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color seen"></span>
                    <span>Seen (mixed fragment)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color pending"></span>
                    <span>Pending</span>
                </div>
            </div>
            
            <!-- Assembled UR Display -->
            <div id="assembled-ur-section" style="display:none; margin-top:24px;">
                <div class="section-label">‚úÖ Assembled UR (Complete)</div>
                <textarea
                    id="assembled-ur-output"
                    class="text-area"
                    readonly
                    rows="4"
                    placeholder="Assembled UR will appear here..."
                ></textarea>
                <button id="copy-assembled-ur" class="example-btn" style="margin-top:8px;">üìã Copy UR</button>
            </div>
            
            <!-- Troubleshooting Tips -->
            <div id="troubleshooting-tips" class="troubleshooting" style="display:none; margin-top:24px;">
                <strong>No QR code detected. Try:</strong>
                <ul>
                    <li>Hold camera steady</li>
                    <li>Ensure good lighting</li>
                    <li>QR code fully visible in frame</li>
                    <li>Move camera closer/farther</li>
                </ul>
            </div>
            
            <!-- Usage Instructions -->
            <div class="usage-instructions">
                <div class="section-label">üìù How to Use</div>
                <ol>
                    <li>Camera starts automatically when you open this tab (grant permission when asked)</li>
                    <li>Point camera at animated QR code sequence</li>
                    <li><strong>Optimal distance:</strong> 6-12 inches (15-30cm) - QR should fill 40-60% of screen</li>
                    <li>Tap screen to focus if QR appears blurry</li>
                    <li>Watch progress grid fill as fragments are decoded</li>
                    <li>Assembled UR auto-forwards to Converter tab when complete</li>
                </ol>
                <p><strong>Note:</strong> Camera access requires HTTPS (localhost OK for development)</p>
                <p style="color: #586069; font-size: 0.9em; margin-top: 8px;">
                    üí° <strong>Tip:</strong> If scanning fails, try moving camera closer/farther or adjusting lighting
                </p>
            </div>
        </div>

        <!-- Tab 4: Registry Browser -->
        <div class="tab-content hidden" id="registry-tab">
            <div class="section-label">üìñ Registry Browser & Type Inspection</div>

            <!-- Status -->
            <div id="registryStatus" class="status">
                <span class="status-icon">‚ÑπÔ∏è</span>
                <span>Loading registry types...</span>
            </div>

            <!-- Search Bar -->
            <div style="margin-top: 16px; margin-bottom: 16px;">
                <input
                    type="text"
                    id="registrySearch"
                    placeholder="üîç Search registry types..."
                    style="width: 100%; padding: 10px; border: 2px solid #e1e4e8; border-radius: 6px; font-size: 14px;"
                />
            </div>

            <!-- Registry List -->
            <div id="registryList" class="registry-list" style="margin-top: 16px;">
                <!-- Registry types will be rendered here -->
            </div>

            <!-- Usage Instructions -->
            <div class="usage-instructions" style="margin-top: 32px;">
                <div class="section-label">üìù How to Use</div>
                <ol>
                    <li>Browse registered UR types organized by package</li>
                    <li>Click on package headers to expand/collapse type lists</li>
                    <li>Click on type rows to view CDDL schemas and documentation</li>
                    <li>Click on CBOR tags in CDDL (e.g., <code>#6.41402(detailed-account)</code>) to navigate to definitions</li>
                    <li>Use the search bar to filter types by name, tag, or description</li>
                    <li>Copy CDDL schemas for reference or validation</li>
                </ol>
                <p style="color: #586069; font-size: 0.9em; margin-top: 8px;">
                    üí° <strong>Tip:</strong> Open browser console to use <code>window.registryPlayground</code> API for interactive testing
                </p>
                <p style="color: #586069; font-size: 0.9em; margin-top: 8px;">
                    ‚ÑπÔ∏è Unknown CBOR tags are looked up from the IANA registry: <a href="https://www.iana.org/assignments/cbor-tags/cbor-tags.xhtml" target="_blank" rel="noopener noreferrer" style="color: #0066cc;">https://www.iana.org/assignments/cbor-tags/cbor-tags.xhtml</a>
                </p>
            </div>
        </div>
    </div>

    <script type="module">
        // Initialize router for tab navigation
        import Router from './js/router.js';

        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        function initializeApp() {
            // Initialize router with tab navigation
            const router = new Router();
            router.init();

            // Expose router globally for use by tab modules
            window.router = router;

            console.log('BC-UR Playground initialized');
        }
    </script>
    <script type="module" src="js/converter.js"></script>
    <script type="module" src="js/scanner.js"></script>
    <script type="module" src="js/multi-ur.js"></script>
    <script type="module" src="js/registry.js"></script>
</body>
</html>
