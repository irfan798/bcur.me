<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" 
      content="script-src 'self' 'unsafe-eval' 'unsafe-inline' https://esm.sh blob:; worker-src 'self' blob:;">
    <title>BC-UR Playground</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/tabs.css">

    <!-- Import Map: Conditional inline based on environment -->
    <!-- Production: Update this manually or via build script to use CDN URLs -->
    <script>
        // Detect environment
        const isDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        
        // Define import maps for each environment
        const devImports = {
            // Local bc-ur package with bundled CBOR2 (ESM version uses bundled deps)
            "@ngraveio/bc-ur": "/node_modules/@ngraveio/bc-ur/dist/esm/index.js",
            // bc-ur ESM dependencies (bare imports that need mapping)
            "buffer": "https://esm.sh/buffer@6.0.3",
            "buffer/": "https://esm.sh/buffer@6.0.3/",
            "uint8array-extras": "/node_modules/uint8array-extras/index.js",
            "crc": "/node_modules/crc/mjs/index.js",
            "sha.js": "https://esm.sh/sha.js@2.4.12",
            // QR libraries (qrcode is CommonJS, use esm.sh for auto-conversion)
            "qrcode": "https://esm.sh/qrcode@1.5.3",
            "qr-scanner": "/node_modules/qr-scanner/qr-scanner.min.js"
        };
        
        const prodImports = {
            "@ngraveio/bc-ur": "https://esm.sh/@ngraveio/bc-ur@2.0.0-beta.9",
            "qrcode": "https://esm.sh/qrcode@1.5.3",
            "qr-scanner": "https://esm.sh/qr-scanner@1.4.2"
        };
        
        // Inject the appropriate import map
        const importMap = document.createElement('script');
        importMap.type = 'importmap';
        importMap.textContent = JSON.stringify({
            imports: isDev ? devImports : prodImports
        });
        document.currentScript.after(importMap);
        
        console.log(`[ImportMap] Loaded ${isDev ? 'development' : 'production'} imports`, isDev ? devImports : prodImports);
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîÑ BC-UR Playground</h1>
            <p>Explore Uniform Resources, multi-part encoding, animated QR codes, and CBOR registry types</p>
        </div>

        <!-- Tab Navigation -->
        <nav class="tab-nav">
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="converter">
                    <span class="tab-icon">üîÑ</span>
                    <span class="tab-label">Converter</span>
                </button>
                <button class="tab-button" data-tab="multi-ur">
                    <span class="tab-icon">üìö</span>
                    <span class="tab-label">Multi-UR Generator</span>
                </button>
                <button class="tab-button" data-tab="scanner">
                    <span class="tab-icon">üì∑</span>
                    <span class="tab-label">QR Scanner</span>
                </button>
                <button class="tab-button" data-tab="registry">
                    <span class="tab-icon">üìñ</span>
                    <span class="tab-label">Registry Browser</span>
                </button>
            </div>
        </nav>

        <!-- Tab 1: Converter (existing converter content) -->
        <div class="tab-content active" id="converter-tab">
            <div class="examples">
                <div class="examples-label">Quick Examples:</div>
                <div class="example-buttons">
                    <button class="example-btn" data-example="hex">Hex Example</button>
                    <button class="example-btn" data-example="ur">UR Example</button>
                    <button class="example-btn" data-example="bytewords">Bytewords Example</button>
                    <button class="example-btn" data-example="multiur">Multi-part UR</button>
                    <button class="example-btn" data-example="detailed-account">Detailed Account</button>
                    <button class="example-btn" data-example="portfolio">Portfolio (complex-ur)</button>
                </div>
            </div>

            <div class="converter-panel">
                <div class="input-section">
                    <div class="section-label">Input</div>
                    <div class="format-row">
                        <select id="inputFormat" class="format-select format-select-inline">
                            <option value="auto">üîç Auto-detect format</option>
                            <option value="multiur">üìö Multi-part UR</option>
                            <option value="ur">üìÑ Single UR</option>
                            <option value="bytewords">üìù Bytewords</option>
                            <option value="hex">üî¢ Hex (CBOR)</option>
                        </select>
                        <select id="inputBytewordsStyle" class="bytewords-style-select" style="display:none;">
                            <option value="minimal">Minimal</option>
                            <option value="standard">Standard</option>
                            <option value="uri">URI</option>
                        </select>
                    </div>
                    <textarea
                        id="inputText"
                        class="text-area"
                        placeholder="Paste or type your input here..."
                        spellcheck="false"
                    ></textarea>
                </div>

                <div class="output-section">
                    <div class="section-label">Output</div>
                    <div class="format-row">
                        <select id="outputFormat" class="format-select format-select-inline">
                            <option value="ur">üìÑ Single UR</option>
                            <option value="bytewords">üìù Bytewords</option>
                            <option value="hex">üî¢ Hex (CBOR)</option>
                            <option value="decoded-json">üìä Decoded CBOR (JSON)</option>
                            <option value="decoded-diagnostic">üìã Decoded CBOR (Diagnostic)</option>
                            <option value="decoded-commented">üí¨ Decoded CBOR (Commented)</option>
                            <option value="decoded-js">üîß Decoded CBOR (JavaScript)</option>
                        </select>
                        <select id="outputBytewordsStyle" class="bytewords-style-select" style="display:none;">
                            <option value="minimal">Minimal</option>
                            <option value="standard">Standard</option>
                            <option value="uri">URI</option>
                        </select>
                        <button id="copyBtn" class="example-btn" style="margin-left:8px; padding:10px 14px; height:42px;">üìã Copy</button>
                        <button id="sendToMultiUR" class="example-btn" style="margin-left:8px; padding:10px 14px; height:42px;">üìö Send to Multi-UR</button>
                    </div>
                    <!-- UR Type override / helper (appears only when needed) -->
                    <div id="urTypeContainer" style="display:none; margin-bottom:12px; position:relative;">
                        <input id="urTypeInput" type="text" placeholder="unknown-tag" style="width:100%; padding:8px 32px 8px 10px; border:2px solid #e1e4e8; border-radius:6px; font-size:13px;" />
                        <span id="urTypeIndicator" style="display:none; position:absolute; top:8px; right:10px; font-size:15px; user-select:none;">‚úì</span>
                        <div style="display:flex; justify-content:space-between; margin-top:4px;">
                            <small id="urTypeHint" style="color:#586069; font-size:11px;">Provide UR type (auto when CBOR tag known)</small>
                            <small id="urTypeAutoBadge" style="display:none; background:#e1f5e6; color:#0a7a25; padding:2px 6px; border-radius:12px; font-size:11px;">Auto-detected</small>
                        </div>
                    </div>
                    <textarea
                        id="outputText"
                        class="text-area"
                        readonly
                        placeholder="Converted output will appear here..."
                        spellcheck="false"
                    ></textarea>
                </div>
            </div>

            <div class="pipeline" id="pipeline">
                <div class="pipeline-header">Conversion Pipeline Status</div>
                <div class="pipeline-flow">
                    <span class="pipeline-step inactive" data-step="multiur">Multi-UR</span>
                    <span class="pipeline-arrow">‚Üí</span>
                    <span class="pipeline-step inactive" data-step="ur">UR</span>
                    <span class="pipeline-arrow">‚Üí</span>
                    <span class="pipeline-step inactive" data-step="bytewords">Bytewords</span>
                    <span class="pipeline-arrow">‚Üí</span>
                    <span class="pipeline-step inactive" data-step="hex">Hex</span>
                    <span class="pipeline-arrow">‚Üí</span>
                    <span class="pipeline-step inactive" data-step="decoded">Decoded</span>
                </div>
            </div>

            <div class="status success" id="status">
                <span class="status-icon">‚ÑπÔ∏è</span>
                <span>Ready for input</span>
            </div>
        </div>

        <!-- Tab 2: Multi-UR Generator (placeholder) -->
        <div class="tab-content hidden" id="multi-ur-tab">
            <div class="section-label">Multi-Part UR Generator</div>
            <p style="color: #586069; text-align: center; padding: 40px;">Coming soon: Generate fountain-encoded multi-part URs with animated QR codes</p>
        </div>

        <!-- Tab 3: QR Scanner -->
        <div class="tab-content hidden" id="scanner-tab">
            <div class="section-label">üì∑ QR Code Scanner & Fountain Decoder</div>
            
            <!-- Camera Status -->
            <div id="camera-status" class="status">Camera: Starting...</div>
            
            <!-- Camera Controls -->
            <div class="scanner-controls">
                <button id="stop-camera" class="example-btn" style="display:none;">‚èπÔ∏è Stop Camera</button>
                <button id="reset-scanner" class="example-btn" style="display:none;">üîÑ Reset</button>
                <button id="toggle-torch" class="example-btn" style="display:none;">üî¶ Torch: OFF</button>
            </div>
            
            <!-- Type Mismatch Warning -->
            <div id="type-mismatch-warning" class="status error" style="display:none; margin-top:12px;"></div>
            
            <!-- Video Preview -->
            <div class="scanner-preview">
                <video id="scanner-video" playsinline></video>
            </div>
            
            <!-- Progress Display -->
            <div id="scan-progress" class="section-label" style="display:none; margin-top:16px;">
                Waiting for first QR code...
            </div>
            
            <!-- Progress Bar -->
            <div class="progress-bar-container" style="margin-top:12px;">
                <div id="progress-bar" class="progress-bar"></div>
            </div>
            
            <!-- Blocks Grid Visualization -->
            <div class="section-label" style="margin-top:24px;">Block Status Grid</div>
            <div id="blocks-grid" class="blocks-grid"></div>
            
            <!-- Grid Legend -->
            <div class="grid-legend">
                <div class="legend-item">
                    <span class="legend-color decoded"></span>
                    <span>Decoded (resolved)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color seen"></span>
                    <span>Seen (mixed fragment)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color pending"></span>
                    <span>Pending</span>
                </div>
            </div>
            
            <!-- Assembled UR Display -->
            <div id="assembled-ur-section" style="display:none; margin-top:24px;">
                <div class="section-label">‚úÖ Assembled UR (Complete)</div>
                <textarea
                    id="assembled-ur-output"
                    class="text-area"
                    readonly
                    rows="4"
                    placeholder="Assembled UR will appear here..."
                ></textarea>
                <button id="copy-assembled-ur" class="example-btn" style="margin-top:8px;">üìã Copy UR</button>
            </div>
            
            <!-- Troubleshooting Tips -->
            <div id="troubleshooting-tips" class="troubleshooting" style="display:none; margin-top:24px;">
                <strong>No QR code detected. Try:</strong>
                <ul>
                    <li>Hold camera steady</li>
                    <li>Ensure good lighting</li>
                    <li>QR code fully visible in frame</li>
                    <li>Move camera closer/farther</li>
                </ul>
            </div>
            
            <!-- Usage Instructions -->
            <div class="usage-instructions">
                <div class="section-label">üìù How to Use</div>
                <ol>
                    <li>Camera starts automatically when you open this tab (grant permission when asked)</li>
                    <li>Point camera at animated QR code sequence</li>
                    <li><strong>Optimal distance:</strong> 6-12 inches (15-30cm) - QR should fill 40-60% of screen</li>
                    <li>Tap screen to focus if QR appears blurry</li>
                    <li>Watch progress grid fill as fragments are decoded</li>
                    <li>Assembled UR auto-forwards to Converter tab when complete</li>
                </ol>
                <p><strong>Note:</strong> Camera access requires HTTPS (localhost OK for development)</p>
                <p style="color: #586069; font-size: 0.9em; margin-top: 8px;">
                    üí° <strong>Tip:</strong> If scanning fails, try moving camera closer/farther or adjusting lighting
                </p>
            </div>
        </div>

        <!-- Tab 4: Registry Browser (placeholder) -->
        <div class="tab-content hidden" id="registry-tab">
            <div class="section-label">Registry Browser</div>
            <p style="color: #586069; text-align: center; padding: 40px;">Coming soon: Browse registered UR types and CDDL schemas</p>
        </div>
    </div>

    <script type="module">
        // Initialize router for tab navigation
        import Router from './js/router.js';

        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        function initializeApp() {
            // Initialize router with tab navigation
            const router = new Router();
            router.init();

            // Expose router globally for use by tab modules
            window.router = router;

            console.log('BC-UR Playground initialized');
        }
    </script>
    <script type="module" src="js/converter.js"></script>
    <script type="module" src="js/scanner.js"></script>
</body>
</html>
