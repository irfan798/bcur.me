# BC-UR Build Issue - Visual Explanation

## Current (Broken) Structure

```
dist/
â”œâ”€â”€ esm/ (For browsers and modern Node.js)
â”‚   â””â”€â”€ wrappers/
â”‚       â”œâ”€â”€ cbor2.js
â”‚       â”‚   â””â”€â”€ imports from: "../../commonjs/wrappers/cbor2Wrapper.js"  âŒ BROKEN!
â”‚       â”‚                     (Browsers can't load CommonJS!)
â”‚       â””â”€â”€ cbor2Wrapper.js
â”‚           â””â”€â”€ imports from: 'cbor2' (external)  âŒ Not bundled!
â”‚
â””â”€â”€ commonjs/ (For old Node.js)
    â””â”€â”€ wrappers/
        â””â”€â”€ cbor2Wrapper.js
            â””â”€â”€ contains: [bundled CBOR2 code - 49 lines]  âœ… Working
```

**The Problem**:
```
Browser â†’ ESM cbor2.js â†’ tries to load CommonJS file â†’ ERROR! ğŸ’¥
```

---

## My Fix (Current Workaround)

```
dist/
â”œâ”€â”€ esm/
â”‚   â””â”€â”€ wrappers/
â”‚       â”œâ”€â”€ cbor2.js
â”‚       â”‚   â””â”€â”€ imports from: "./cbor2Wrapper.js"  âœ… FIXED (local ESM)
â”‚       â”‚
â”‚       â”œâ”€â”€ cbor2Wrapper.js
â”‚       â”‚   â””â”€â”€ imports from: "./cbor2Wrapper-fixed.js"  âœ… FIXED
â”‚       â”‚
â”‚       â””â”€â”€ cbor2Wrapper-fixed.js  ğŸ†• NEW FILE
â”‚           â””â”€â”€ contains: [bundled CBOR2 code - ESM format]  âœ…
â”‚
â””â”€â”€ commonjs/ (unchanged)
    â””â”€â”€ wrappers/
        â””â”€â”€ cbor2Wrapper.js
            â””â”€â”€ contains: [bundled CBOR2 code - CJS format]  âœ…
```

**How it works**:
```
Browser â†’ ESM cbor2.js â†’ ESM cbor2Wrapper.js â†’ ESM cbor2Wrapper-fixed.js (bundled) â†’ âœ… Works!
Node.js (CJS) â†’ CJS cbor2Wrapper.js (bundled) â†’ âœ… Works!
Node.js (ESM) â†’ ESM cbor2.js â†’ ESM cbor2Wrapper-fixed.js (bundled) â†’ âœ… Works!
```

**Conversion Command**:
```bash
# CommonJS â†’ ESM conversion
sed '1d; s/^exports\./export const /; s/ = \([^;]*\);$/ = \1;/' \
  dist/commonjs/wrappers/cbor2Wrapper.js > dist/esm/wrappers/cbor2Wrapper-fixed.js
```

---

## Proper Fix (For bc-ur Maintainers)

```
Build Process (Rollup):
  
  Source: src/wrappers/cbor2Wrapper.ts
           â””â”€â”€ imports from: 'cbor2' (external)
  
  â†“ Rollup bundles CBOR2
  
  Output 1: dist/commonjs/wrappers/cbor2Wrapper.js
            â””â”€â”€ contains: [bundled CBOR2 in CommonJS]  âœ…
  
  Output 2: dist/esm/wrappers/cbor2Wrapper.js  ğŸ†• ADD THIS
            â””â”€â”€ contains: [bundled CBOR2 in ESM]  âœ…
```

**Final Structure**:
```
dist/
â”œâ”€â”€ esm/
â”‚   â””â”€â”€ wrappers/
â”‚       â”œâ”€â”€ cbor2.js
â”‚       â”‚   â””â”€â”€ imports from: "./cbor2Wrapper.js"  âœ…
â”‚       â”‚
â”‚       â””â”€â”€ cbor2Wrapper.js
â”‚           â””â”€â”€ contains: [bundled CBOR2 code - ESM]  âœ… Generated by Rollup
â”‚
â””â”€â”€ commonjs/
    â””â”€â”€ wrappers/
        â””â”€â”€ cbor2Wrapper.js
            â””â”€â”€ contains: [bundled CBOR2 code - CJS]  âœ… Generated by Rollup
```

**Build Script** (`rollup.config.mjs`):
```javascript
export default [
  // Existing: CommonJS bundle
  {
    input: 'src/wrappers/cbor2Wrapper.ts',
    output: {
      file: 'dist/commonjs/wrappers/cbor2Wrapper.js',
      format: 'cjs'
    },
    plugins: [bundleCbor2()]
  },
  // NEW: ESM bundle
  {
    input: 'src/wrappers/cbor2Wrapper.ts',
    output: {
      file: 'dist/esm/wrappers/cbor2Wrapper.js',
      format: 'esm'  // â† Same bundling, different format
    },
    plugins: [bundleCbor2()]
  }
]
```

---

## Alternative: Use cbor2 ESM Directly (No Bundling)

```
dist/
â”œâ”€â”€ esm/
â”‚   â””â”€â”€ wrappers/
â”‚       â”œâ”€â”€ cbor2.js
â”‚       â”‚   â””â”€â”€ imports from: "./cbor2Wrapper.js"  âœ…
â”‚       â”‚
â”‚       â””â”€â”€ cbor2Wrapper.js
â”‚           â””â”€â”€ imports from: 'cbor2' (external npm package)  ğŸ“¦
â”‚                            'cbor2/encoder'
â”‚
â””â”€â”€ commonjs/
    â””â”€â”€ wrappers/
        â””â”€â”€ cbor2Wrapper.js
            â””â”€â”€ contains: [bundled CBOR2 code]  âœ…
```

**Pros**:
- âœ… Simpler (no bundling for ESM)
- âœ… Works in browsers
- âœ… Smaller bundle (shared dependency)

**Cons**:
- âŒ Dual Package Hazard returns:
  ```
  ESM â†’ external cbor2 (instance A)
  CJS â†’ bundled cbor2 (instance B)
  
  Instance A !== Instance B  ğŸ’¥
  ```
- âŒ Requires cbor2 as peer dependency
- âŒ Version conflicts possible

**When to use**: ESM-only apps where Dual Package Hazard is not a concern.

---

## Dual Package Hazard Explained

### Without Bundling (The Problem)

```
App using both ESM and CommonJS:

  ESM import                    CommonJS require
       â†“                              â†“
  bc-ur (ESM)                   bc-ur (CommonJS)
       â†“                              â†“
  cbor2 (from npm)              cbor2 (bundled)
       â†“                              â†“
  Tag class (A)                 Tag class (B)
  
  A !== B  ğŸ’¥  (Two different instances!)
  
  tag1 instanceof Tag (from ESM) = true
  tag1 instanceof Tag (from CJS) = false  âŒ BROKEN!
```

### With Bundling (The Solution)

```
App using both ESM and CommonJS:

  ESM import                    CommonJS require
       â†“                              â†“
  bc-ur (ESM)                   bc-ur (CommonJS)
       â†“                              â†“
  bundled cbor2 (ESM)           bundled cbor2 (CJS)
       â†“                              â†“
  Tag class (A)                 Tag class (B)
  
  A === B  âœ…  (Same source code, just different format!)
  
  Both share the same CBOR tag registry
  instanceof works across boundaries
  No duplicate singleton state
```

---

## Import Map Solution (For Browsers)

**The imports that needed mapping**:

```javascript
// bc-ur ESM build imports these:
import { Buffer } from "buffer/";              // â† Trailing slash!
import { crc32 } from "crc";
import { createHash } from "sha.js";
import { isUint8Array } from "uint8array-extras";

// Import map resolves them:
{
  "@ngraveio/bc-ur": "/node_modules/@ngraveio/bc-ur/dist/esm/index.js",
  
  // bc-ur dependencies
  "buffer": "https://esm.sh/buffer@6.0.3",
  "buffer/": "https://esm.sh/buffer@6.0.3/",   // Must have trailing slash!
  "crc": "/node_modules/crc/mjs/index.js",
  "sha.js": "https://esm.sh/sha.js@2.4.12",    // CommonJS â†’ use esm.sh
  "uint8array-extras": "/node_modules/uint8array-extras/index.js",
  
  // App dependencies
  "qrcode": "https://esm.sh/qrcode@1.5.3",     // CommonJS â†’ use esm.sh
  "qr-scanner": "/node_modules/qr-scanner/qr-scanner.min.js"
}
```

**Why trailing slash matters**:
```javascript
// Import map spec:
// If key has trailing slash, value MUST also have trailing slash!

// âŒ WRONG:
"buffer/": "/node_modules/buffer/index.js"  // No trailing slash in value

// âœ… CORRECT:
"buffer/": "https://esm.sh/buffer@6.0.3/"   // Trailing slash in value
```

---

## Summary Flow Chart

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           BC-UR Package Structure Problem               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  ESM build â†’ references CommonJS files â†’ âŒ Browser    â”‚
â”‚  ESM build â†’ imports external cbor2 â†’ âŒ Not bundled   â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   My Fix (Now)   â”‚                  â”‚  Proper Fix      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  â”‚                  â”‚                  â”‚
â”‚ Convert CJS      â”‚                  â”‚ Update Rollup    â”‚
â”‚ bundle â†’ ESM     â”‚                  â”‚ to generate      â”‚
â”‚                  â”‚                  â”‚ both formats     â”‚
â”‚ Manual patch     â”‚                  â”‚                  â”‚
â”‚ node_modules     â”‚                  â”‚ Official release â”‚
â”‚                  â”‚                  â”‚                  â”‚
â”‚ âœ… Works now     â”‚                  â”‚ âœ… Permanent     â”‚
â”‚ âš ï¸ Re-patch      â”‚                  â”‚ âœ… Automated     â”‚
â”‚    after yarn    â”‚                  â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Key Takeaways

1. **Problem**: ESM build references CommonJS files (browsers can't load them)
2. **Root Cause**: Build process only bundles CBOR2 for CommonJS, not ESM
3. **My Fix**: Manually convert CJS bundle to ESM format
4. **Proper Fix**: Update Rollup to bundle CBOR2 for both formats
5. **Alternative**: Use cbor2 ESM directly (but loses Dual Package Hazard protection)
6. **Works Everywhere**: Browser âœ…, Node.js (CJS) âœ…, Node.js (ESM) âœ…

**Files for bc-ur maintainers**:
- `BC-UR_BUILD_FIX_TASK.md` - Implementation details
- `BC-UR_FIX_DIAGRAM.md` - This visual guide
- `QUICK_ANSWERS.md` - Q&A summary
