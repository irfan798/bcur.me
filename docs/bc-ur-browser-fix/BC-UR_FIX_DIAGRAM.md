# BC-UR Build Issue - Visual Explanation

## Current (Broken) Structure

```
dist/
├── esm/ (For browsers and modern Node.js)
│   └── wrappers/
│       ├── cbor2.js
│       │   └── imports from: "../../commonjs/wrappers/cbor2Wrapper.js"  ❌ BROKEN!
│       │                     (Browsers can't load CommonJS!)
│       └── cbor2Wrapper.js
│           └── imports from: 'cbor2' (external)  ❌ Not bundled!
│
└── commonjs/ (For old Node.js)
    └── wrappers/
        └── cbor2Wrapper.js
            └── contains: [bundled CBOR2 code - 49 lines]  ✅ Working
```

**The Problem**:
```
Browser → ESM cbor2.js → tries to load CommonJS file → ERROR! 💥
```

---

## My Fix (Current Workaround)

```
dist/
├── esm/
│   └── wrappers/
│       ├── cbor2.js
│       │   └── imports from: "./cbor2Wrapper.js"  ✅ FIXED (local ESM)
│       │
│       ├── cbor2Wrapper.js
│       │   └── imports from: "./cbor2Wrapper-fixed.js"  ✅ FIXED
│       │
│       └── cbor2Wrapper-fixed.js  🆕 NEW FILE
│           └── contains: [bundled CBOR2 code - ESM format]  ✅
│
└── commonjs/ (unchanged)
    └── wrappers/
        └── cbor2Wrapper.js
            └── contains: [bundled CBOR2 code - CJS format]  ✅
```

**How it works**:
```
Browser → ESM cbor2.js → ESM cbor2Wrapper.js → ESM cbor2Wrapper-fixed.js (bundled) → ✅ Works!
Node.js (CJS) → CJS cbor2Wrapper.js (bundled) → ✅ Works!
Node.js (ESM) → ESM cbor2.js → ESM cbor2Wrapper-fixed.js (bundled) → ✅ Works!
```

**Conversion Command**:
```bash
# CommonJS → ESM conversion
sed '1d; s/^exports\./export const /; s/ = \([^;]*\);$/ = \1;/' \
  dist/commonjs/wrappers/cbor2Wrapper.js > dist/esm/wrappers/cbor2Wrapper-fixed.js
```

---

## Proper Fix (For bc-ur Maintainers)

```
Build Process (Rollup):
  
  Source: src/wrappers/cbor2Wrapper.ts
           └── imports from: 'cbor2' (external)
  
  ↓ Rollup bundles CBOR2
  
  Output 1: dist/commonjs/wrappers/cbor2Wrapper.js
            └── contains: [bundled CBOR2 in CommonJS]  ✅
  
  Output 2: dist/esm/wrappers/cbor2Wrapper.js  🆕 ADD THIS
            └── contains: [bundled CBOR2 in ESM]  ✅
```

**Final Structure**:
```
dist/
├── esm/
│   └── wrappers/
│       ├── cbor2.js
│       │   └── imports from: "./cbor2Wrapper.js"  ✅
│       │
│       └── cbor2Wrapper.js
│           └── contains: [bundled CBOR2 code - ESM]  ✅ Generated by Rollup
│
└── commonjs/
    └── wrappers/
        └── cbor2Wrapper.js
            └── contains: [bundled CBOR2 code - CJS]  ✅ Generated by Rollup
```

**Build Script** (`rollup.config.mjs`):
```javascript
export default [
  // Existing: CommonJS bundle
  {
    input: 'src/wrappers/cbor2Wrapper.ts',
    output: {
      file: 'dist/commonjs/wrappers/cbor2Wrapper.js',
      format: 'cjs'
    },
    plugins: [bundleCbor2()]
  },
  // NEW: ESM bundle
  {
    input: 'src/wrappers/cbor2Wrapper.ts',
    output: {
      file: 'dist/esm/wrappers/cbor2Wrapper.js',
      format: 'esm'  // ← Same bundling, different format
    },
    plugins: [bundleCbor2()]
  }
]
```

---

## Alternative: Use cbor2 ESM Directly (No Bundling)

```
dist/
├── esm/
│   └── wrappers/
│       ├── cbor2.js
│       │   └── imports from: "./cbor2Wrapper.js"  ✅
│       │
│       └── cbor2Wrapper.js
│           └── imports from: 'cbor2' (external npm package)  📦
│                            'cbor2/encoder'
│
└── commonjs/
    └── wrappers/
        └── cbor2Wrapper.js
            └── contains: [bundled CBOR2 code]  ✅
```

**Pros**:
- ✅ Simpler (no bundling for ESM)
- ✅ Works in browsers
- ✅ Smaller bundle (shared dependency)

**Cons**:
- ❌ Dual Package Hazard returns:
  ```
  ESM → external cbor2 (instance A)
  CJS → bundled cbor2 (instance B)
  
  Instance A !== Instance B  💥
  ```
- ❌ Requires cbor2 as peer dependency
- ❌ Version conflicts possible

**When to use**: ESM-only apps where Dual Package Hazard is not a concern.

---

## Dual Package Hazard Explained

### Without Bundling (The Problem)

```
App using both ESM and CommonJS:

  ESM import                    CommonJS require
       ↓                              ↓
  bc-ur (ESM)                   bc-ur (CommonJS)
       ↓                              ↓
  cbor2 (from npm)              cbor2 (bundled)
       ↓                              ↓
  Tag class (A)                 Tag class (B)
  
  A !== B  💥  (Two different instances!)
  
  tag1 instanceof Tag (from ESM) = true
  tag1 instanceof Tag (from CJS) = false  ❌ BROKEN!
```

### With Bundling (The Solution)

```
App using both ESM and CommonJS:

  ESM import                    CommonJS require
       ↓                              ↓
  bc-ur (ESM)                   bc-ur (CommonJS)
       ↓                              ↓
  bundled cbor2 (ESM)           bundled cbor2 (CJS)
       ↓                              ↓
  Tag class (A)                 Tag class (B)
  
  A === B  ✅  (Same source code, just different format!)
  
  Both share the same CBOR tag registry
  instanceof works across boundaries
  No duplicate singleton state
```

---

## Import Map Solution (For Browsers)

**The imports that needed mapping**:

```javascript
// bc-ur ESM build imports these:
import { Buffer } from "buffer/";              // ← Trailing slash!
import { crc32 } from "crc";
import { createHash } from "sha.js";
import { isUint8Array } from "uint8array-extras";

// Import map resolves them:
{
  "@ngraveio/bc-ur": "/node_modules/@ngraveio/bc-ur/dist/esm/index.js",
  
  // bc-ur dependencies
  "buffer": "https://esm.sh/buffer@6.0.3",
  "buffer/": "https://esm.sh/buffer@6.0.3/",   // Must have trailing slash!
  "crc": "/node_modules/crc/mjs/index.js",
  "sha.js": "https://esm.sh/sha.js@2.4.12",    // CommonJS → use esm.sh
  "uint8array-extras": "/node_modules/uint8array-extras/index.js",
  
  // App dependencies
  "qrcode": "https://esm.sh/qrcode@1.5.3",     // CommonJS → use esm.sh
  "qr-scanner": "/node_modules/qr-scanner/qr-scanner.min.js"
}
```

**Why trailing slash matters**:
```javascript
// Import map spec:
// If key has trailing slash, value MUST also have trailing slash!

// ❌ WRONG:
"buffer/": "/node_modules/buffer/index.js"  // No trailing slash in value

// ✅ CORRECT:
"buffer/": "https://esm.sh/buffer@6.0.3/"   // Trailing slash in value
```

---

## Summary Flow Chart

```
┌─────────────────────────────────────────────────────────┐
│           BC-UR Package Structure Problem               │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ESM build → references CommonJS files → ❌ Browser    │
│  ESM build → imports external cbor2 → ❌ Not bundled   │
│                                                         │
└─────────────────────────────────────────────────────────┘
                            ↓
        ┌───────────────────┴───────────────────┐
        ↓                                       ↓
┌──────────────────┐                  ┌──────────────────┐
│   My Fix (Now)   │                  │  Proper Fix      │
├──────────────────┤                  ├──────────────────┤
│                  │                  │                  │
│ Convert CJS      │                  │ Update Rollup    │
│ bundle → ESM     │                  │ to generate      │
│                  │                  │ both formats     │
│ Manual patch     │                  │                  │
│ node_modules     │                  │ Official release │
│                  │                  │                  │
│ ✅ Works now     │                  │ ✅ Permanent     │
│ ⚠️ Re-patch      │                  │ ✅ Automated     │
│    after yarn    │                  │                  │
└──────────────────┘                  └──────────────────┘
```

---

## Key Takeaways

1. **Problem**: ESM build references CommonJS files (browsers can't load them)
2. **Root Cause**: Build process only bundles CBOR2 for CommonJS, not ESM
3. **My Fix**: Manually convert CJS bundle to ESM format
4. **Proper Fix**: Update Rollup to bundle CBOR2 for both formats
5. **Alternative**: Use cbor2 ESM directly (but loses Dual Package Hazard protection)
6. **Works Everywhere**: Browser ✅, Node.js (CJS) ✅, Node.js (ESM) ✅

**Files for bc-ur maintainers**:
- `BC-UR_BUILD_FIX_TASK.md` - Implementation details
- `BC-UR_FIX_DIAGRAM.md` - This visual guide
- `QUICK_ANSWERS.md` - Q&A summary
